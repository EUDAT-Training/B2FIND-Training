# Search using the Command Line Interface (CLI) 
This document describes the usage of the command line script *searchB2FIND.py*.
 For details see the [ user documentation ] (https://eudat.eu/services/userdoc/b2find-usage).

##Prerequisites

### 1. The Pyton script
The script ```searchB2FIND.py``` the Python client ```ckanclient 0.10``` for the CKAN API. Both comes already with this training package.

## Usage

### 1. Usage, help and syntax
Start please by checking the help
```sh
./searchB2FIND.py -h
usage: searchB2FIND.py [-h] [--ckan IP/URL] [--output STRING]
                       [--community STRING] [--request STRING]
                       [--keys [KEYS [KEYS ...]]]
                       [PATTERN [PATTERN ...]]

Description: Lists identifers of datasets that fulfill the given search criteria

positional arguments:
  PATTERN               CKAN search pattern, i.e. by logical conjunctions
                        joined field:value terms.

optional arguments:
  -h, --help            show this help message and exit
  --ckan IP/URL         CKAN portal address, to which search requests are
                        submitted (default is b2find.eudat.eu)
  --output STRING, -o STRING
                        Output file name and format. Format is determined by
                        the extention, supported are 'txt' (plain ascii file)
                        or 'hd5' file. Default is the ascii file results.txt.
  --community STRING, -c STRING
                        Community where you want to search in
  --request STRING, -r STRING
                        Request command. Default is package_search, and as
                        list requests are ['package_list', 'group_list',
                        'tag_list'] supported
  --keys [KEYS [KEYS ...]], -k [KEYS [KEYS ...]]
                        B2FIND fields to be outputed for the found records, by
                        default only the CKAN name (B2FIND identifier) is
                        outputed. If set to None only total numbers of records
                        are printed. Additionally statistical information for
                        the given keys is printed to the file stat_results.txt

Examples:
           1. >./searchB2FIND.py -c aleph tags:LEP
             searchs for all datasets of community ALEPH with tag "LEP" in b2find.eudat.eu.
           2. >./searchB2FIND.py author:"Jones*" AND Discipline:"Crystal?Structure" --ckan eudat-b1.dkrz.de
             searchs in eudat-b1.dkrz.de for all datasets having an author starting with "Jones" and belongs to the discipline "Crystal Structure"
           3. >./searchB2FIND.py -c narcis DOI:'*' --keys DOI
             returns the list of id's and DOI's for all records in community "NARCIS" that have a DOI
```

### 2. Some simple requests
We start with some simple list requests.

#### List communities (groups)

To list all `communities` integarted in B2FIND submit the command
```sh
./searchB2FIND.py -r community_list
	aleph
	b2share
	cessda
	clarin
	dariah
	datacite
	earlinet
	enes
	gbif
	ist
	ivoa
	narcis
	pandata
	pdc
	sdl
	theeuropeanlibrary
```

To list all `groups` of another CKAN instance, e.g. the CKAN demo site submit

```sh
./searchB2FIND.py -r community_list --ckan demo.ckan.org
```

#### List tags (keywords)


#### List datasets (packages)


### 3. Facetted search along a concrete Use Case
We explain the several facets you can search for in detail along a concrete use case. 

> A scientist is interested in research data that is affected to polar coasts.
> She knows that the especially the 'Polar Data Catalogue' comprieses offers access
> to this kind of data. Furthermore she knows that her colleague Dustin published 
> some interesting datasets about this topic in the last 26 years.  
> In the first stage and to shrink the amount of found datasets she focus on research
> covering the 20th century. And she knows that there are interesting studies about a
> small coastal region at the northern boarder between Alaska and Canada.    

In the sub following sub section we explain first how for the single facets can be searched for
and finally we provide the result of a full combined search, which leads hopefully to the desired 
results our researcher needs for her own study. 

#### Free text search

If you just want to search for a word in the full bodies of all metadata records just add as only parameter this word. E.g. entering `coast` as argument results in a list of all records (written to ```results.txt```) in which `coast` occurs.

```
./searchB2FIND.py 'coast'
 | - Search
	|- in	b2find.eudat.eu
	|- for	coast

 | - Results:
	|- 552 records found in 4 sec
        ...
```

#### `Textual` facets

The B2FIND schema comprises the textual facets **Title**, **Description**, **Tags**, **Creator**, **Discipline**, **Language** and **Publisher**. You can search for them by adding the argument ```**facet**:**value**```. 

##### Community (or group)
For the sake of this example, we assume you want filter out all datasets of the B2FIND catalogue belonging to the community (CKAN group) `PDC`. This can done by using the option ```[--community -c]```.

```sh
[k204019@centos67 B2FIND-Training]$ ./searchB2FIND.py -c pdc
 | - Search
	|- in	b2find.eudat.eu
	|- for	groups:pdc AND * : *

 | - Results:
	|- 1959 records found in 10 sec
```

In case of a CKAN instance where the facet **Community** is not implemented as a searchable CKAN field, you can instead search for a CKAN *group*. E.g. to find in the CKAN demo site the group 'Dados Governamentais' you have to know the CKAN short name of this group, which is in this case 'governo'.

```sh
$ ./searchB2FIND.py groups:governo --ckan demo.ckan.org
 | - Search
	|- in	demo.ckan.org
	|- for	groups:governo

 | - Results:
	|- 15 records found in 0 sec
```

##### Discipline
The facet `Discipline` is only defined in the **B2FIND** schema and there is no related CKAN default field. 

In this example we want filter out all records in B2FIND belonging to the disciplibe `Environmental Science`. 

```sh
$ ./searchB2FIND.py discipline:'Environmental?Science'
 | - Search
	|- in	b2find.eudat.eu
	|- for	Discipline:Environmental?Science

 | - Results:
	|- 1959 records found in 9 sec
```

> Note : The questionmark between the words is important, other wise they would be seperated ...

##### Creator ( author)
In B2FIND the facet *Creator* corresponds to the CKAN default field *Author*.

To filter out all datasets created by `Dustin Whalen` we enter

```sh
$ ./searchB2FIND.py author:Dustin?Whalen
 | - Search
	|- in	b2find.eudat.eu
	|- for	author:Dustin?Whalen

 | - Results:
	|- 38 records found in 0 sec
```

Note the question mark between first and last name. This is needed due to the tokenizing of words in a search string done in the search mechanism of CKAN.

In other CKAN instances, at least the default facet *Author* should be available. E.g. the search in the CKAN demo instance for all datasets with an author with name 'Haseeb' is done by :

```sh
$ ./searchB2FIND.py author:Haseeb --ckan demo.ckan.org
 | - Search
	|- in	demo.ckan.org
	|- for	author:Haseeb

 | - Results:
	|- 2 records found in 0 sec
```

#### Coverage
This means to filter out data objects which cover a specific region or periode. This information is only for a part of the metadata records available or senseful.

For these facets describing coverage the additional implementation of *CKAN extensions* are needed, as done for the B2FIND service and at least the geospatial search as well for the CKAN demo site.

> Note : There are some issues with the interaction of spatial and the other facets, especially the temporal search. 
> Especially apply first the 'Filter by time' and other facetted search before excecuting the 'Filter by location'.

##### Publication year
This is developed by and implemented in B2FIND by the CKAN extension [ckanext-datesearch] (https://github.com/EUDAT-B2FIND/ckanext-datesearch).

To search e.g. for all datasets which are published between the years 1990 and 2016 
is a little bit cumbersome because you can not (yet) really specify an interval of years here. But at least you can use the wildcard `?` to specify the first two decadels of the given periode :

```sh
$ ./searchB2FIND.py PublicationYear:199? OR PublicationYear:200? OR PublicationYear:2010  OR PublicationYear:2011 OR PublicationYear:2012 OR PublicationYear:2013 OR PublicationYear:2014 OR PublicationYear:2015 OR PublicationYear:2016
 | - Search
	|- in	b2find.eudat.eu
	|- for	PublicationYear:199? OR PublicationYear:200? OR PublicationYear:2010 OR PublicationYear:2011 OR PublicationYear:2012 OR PublicationYear:2013 OR PublicationYear:2014 OR PublicationYear:2015 OR PublicationYear:2016

 | - Results:
	|- 370865 records found in 9 sec
```

##### Temporal coverage (*Filter by Time*)
This is developed by and implemented in B2FIND through the CKAN extension [ckanext-timeline] (https://github.com/EUDAT-B2FIND/ckanext-timeline).

To search e.g. for all datasets their temporal extent has an overlap with the 20th century, we can filter all datasets their temporal extent don't start after year 2000 but as well end after 1900.

```sh
 ./searchB2FIND.py NOT TemporalCoverageBeginDate:2* OR TemporalCoverageEndDate:19* OR TemporalCoverageEndDate:20*
 | - Search
	|- in	b2find.eudat.eu
	|- for	NOT TemporalCoverageBeginDate:2* OR TemporalCoverageEndDate:19* OR TemporalCoverageEndDate:20*

 | - Results:
	|- 4416 records found in 8 sec  
```

> Note : This search is quite cumbersome and only approximately in means of the results.
> A better, more usable solution is on the way.

##### Geospatial Coverage

This is implemented in B2FIND through the adapted CKAN extension [ckanext-spatial] (https://github.com/ckan/ckanext-spatial).

Imagine we want to filter out all datasets their spatial extent has an overlap with a small region around the coast line at the northern border between Alaska and Canada.

> Note : This is not implemented yet

#### Combined search
We want now combine all the single search criteria together by conducting several search requests sequentially.

I.e. for the example searches given above we search for all datasets that fulfill each of the following criteria (we only list here the facets at the moment can be proper searched for from command line):

1. The word `coast` is found in the full text body of the metadata record
2. The data belongs to the community *PDC*
3. The data is 'created' by `Dustin Whalen`
4. The data is origined from the discipline 'Environmental Science'
6. The data is published after 1990 and before 2016

You can call all these sub requests in one call by joining them all together by `AND` :

```sh
./searchB2FIND.py -c pdc 'coast' Discipline:'Environmental?Science' author:Dustin?Whalen AND PublicationYear:199? OR PublicationYear:200? OR PublicationYear:2010  OR PublicationYear:2011 OR PublicationYear:2012 OR PublicationYear:2013 OR PublicationYear:2014 OR PublicationYear:2015 OR PublicationYear:2016
 | - Search
	|- in	b2find.eudat.eu
	|- for	groups:pdc AND coast Discipline:Environmental?Science author:Dustin?Whalen AND PublicationYear:199? OR PublicationYear:200? OR PublicationYear:2010 OR PublicationYear:2011 OR PublicationYear:2012 OR PublicationYear:2013 OR PublicationYear:2014 OR PublicationYear:2015 OR PublicationYear:2016

 | - Results:
	|- 17 records found in 0 sec
	[==============      ]    12 ( 70%) in 0 sec
	[====================]    17 (100%) in 0 sec
```   
