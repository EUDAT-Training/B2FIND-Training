# Mapping of Metadata
This document describes how to convert, map and homogenize community specific structured and formated XML records to B2FIND schema JSON records. These JSON records are necessary to make metadata available with CKAN. Thus, this part provides the interface between the harvested data and the actual metadata catalogue. A vital part of the conversion step is the semantical mapping. 

## Environment
Ubuntu 14.04 server

##Prerequisites

### 1. The script mdmanger.py
The python script [`mdmanger.py`](00.b-mdmanager-script.md) is used in the mode `m` for this training module.

### 2. Spreadsheet template
If you are a community interested to publish your metedata within EUDAT-B2FIND, description of the specific mapping to the B2FIND schema is needed. For this the tab **Mapping V n.m (YYMMDD)** in the excel template **Community-B2FIND.template.xlsx** has to be filled out (see [Specification of metadata](01.a-specify-metadata.md) ).

However, for this training it is not needed. We will continue with the *fishproject* as an example.

### 3. The mapping files
The mapping files are configuration files named according to this pattern ```<community>-<mdformat>.xml```. We provide some examples in the directory `mapfiles`. If you already followed part 01.b you will find your mapping for the *fishproject* here. The specific files define the mapping rules for XML records, originated from <community> and formated in <mdformat> and turn them into well-formatted JSON files.  

### 4. The XML samples
The mapping script expects that the XML files to map reside in the directory ```oaidata/<Community>-<MDformat>```.

## The Mapping process
In this section we focus on the technical part of the mapping, i.e. how to apply the script.
### 1. Configuration of the mapping

From part 01.b you will already have mapping files for the *fishproject*. We also provide the mapping for the community *Data Cite* and their collection *ANDS*:

1. **fishProject-oai_dc.xml** for the mapping of the DublinCore elements in the XML records of the fishProject onto the B2FIND schema.
2. **datacite-oai_dc.xml** for the mapping of the DublinCore elements in the DataCite XML records onto the B2FIND schema.

Depending on the successful excecution of the previous training module the XML metadata files are available:

1. **fishProject** samples: If you managed to generate metadata as described in *01.b-generate-metadata.md* the XML files reside already in ```oaidata/fishproject-oai_dc/SET_1/xml```. If not create the latter directory and copy the provided samples to this directory:
 ```sh
 $ mkdir -p oaidata/fishproject-oai_dc/SET_1/xml
 $ cp samples/DC_examples/fishProject/xml/*.xml oaidata/fishproject-oai_dc/SET_1/xml
 ``` 

2. **DataCite** samples: If you already managed to harvest metadata as described in *02.b-configure-OAI-harvester.md* the XML files reside already in ```oaidata/oaidata/datacite-oai_dc/ANDS.CENTRE-1/xml```. If not please create this directory and copy the provided samples to this directory:
 ```sh
 mkdir -p oaidata/datacite-oai_dc/ANDS.CENTRE-1/xml
 cp samples/DC_examples/ANDS.CENTRE/*.xml oaidata/oaidata/datacite-oai_dc/ANDS.CENTRE-1/xml
 ```

To perform the mapping properly you need execute the script in ```--mode m``` and you need to set the following parameters.

| Parameter | Description | Option | Pos. in request line | Comments | Example1 | Example 2 |
|-----------|-------------|--------|----------------------|----------|----------|-----------|
| Community | Name of communtiy or project | -c or --community | 1 | Is used in paths | fishproject | datacite |
| Source    | OAI-URL | -s or --source | 2 | Must be set, but irrelevant for the mapping |  http://localhost:8181/oai/provider |  http://oai.datacite.org/oai |
| Verb | The OAI-PMH request or `verb` | --verb | 3 | Not relevant for the mapping | ListIdentifiers | ListRecords | 
| MDprefix  | (OAI) meta data format | --mdprefix | 4 | Set during OAI harvesting | oai_dc | oai_dc |
| Subset    | (OAI) subset | --mdsubset | 5 | If not set during OAI harvesting, it's set to SET_# | SET_1 | ANDS.CENTRE-1_1 | 

E.g. for the 'fishProject' (and with the subset `sample`, as set in module 01.b) we submit the script with the appropriate options :   
```sh
$ ./mdmanager.py --mode m -c fishproject -s http://localhost:8181/oai/provider --mdsubset sample_1 --mdprefix oai_dc
```
**Note** that this command will fail since there is no mapping file mapfiles/fishproject-oai_dc.xml. You can copy the general oai mapping:
```sh
cp mapfiles/datacite-oai_dc.xml mapfiles/fishproject-oai_dc.xml
```

Alternatively, and conveniently for coordinating the harvesting and mapping you can also insert the *fishproject* in the `harvest_list`:
```sh
$ grep fishproject harvest_list
fishproject http://localhost:8181/oai/provider ListIdentifiers oai_dc
```
You might need to adopt the URL according to your machine you are working on.

Subsequently, you can submit the script by only specifying the community in the command line options :

```sh
$ ./mdmanager.py --mode m -c fishproject
```

Both should result in the standard output

```sh
Version:  	2.0
Run mode:   	Mapping
Start : 	2016-11-07 14:47:43


|- Mapping started : 2016-11-07 14:47:43
	[==========          ]     4 ( 50%) in 0 sec
	[====================]     8 (100%) in 0 sec
   	|- Finished   |@ 14:47:45   |
	| Provided | Mapped | Failed |
	|        8 |      8 |      0 |
```

Possibly you have to correct and adapt your mapping to assure fault-free operation. If the program finished successfully check please the resulting JSON files in your project directory.

´´´sh
$ ls oaidata/fishproject-oai_dc/sample_1/json
´´´
and analyse and discuss the resulting JSON records.

**Excercise** 
Perform the mapping for the community 'DataCite'. Note that here the OAI subset ANDS-CENTRE-1 must be specified.
