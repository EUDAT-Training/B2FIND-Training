# Search using the Application Programming Interface (API)
This document describes how you can interact with a CKAN site by submitting directly HTTP requests using the CKAN API v3, on which as well the B2FIND API - and so the search via the GUI (see ```05.b-search-GUI.md```) and via the CLI (see ```05.c-search-CLI.md```) - is based on. For details see the [API guide of CKAN] (http://docs.ckan.org/en/latest/api/index.html). 

##Prerequisites

### 1. Internet browser
Supported and tested are

1. Firefox, version later than 45.x.y
2. Google Chrome, version later than 51.x.y

### 2. CKAN instance 

To follow this tutorial you can use 
- the [B2FIND portal] (http://b2find.eudat.eu) (we are open !),
- your own CKAN installation (see module ```04-install-CKAN.md```) or
- any other CKAN site, e.g. the [CKAN Demo site] (http://demo.ckan.org/).

Please replace *<CKAN-URL>* with the URL pointing to the used CKAN instance.

## Usage

### 1. Submiting API Requests

A HTTP request using directly *CKANâ€™s Action API*, version 3, has the following form 

```sh
http://<CKAN_URL>/api/3/action/<function>[?q=<value>[&fq<facet>:<value>]]
```
with the partly optional parameters:
 
- *CKAN_URL* is the URL of the CKAN site that provides the API. In the examples below we use the B2FIND portal ```b2find.eudat.eu```. In some cases we show examples for the general demo instance of CKAN ```demo.ckan.org```. You can try the requests on any other CKAN site.  
- *function* is one of the supported CKAN API functions. While some of them, as the list commands `group_list` etc., need no further parameters, the search commnds as `package_search` expect further parameters: *facet* and *value*.  
- <facet> is a field of the used schema (in case of B2FIND the B2FIND schema) and
- <value> is the corresponding value searched for.

You can enter the http requests directly in the address field of your internet browser or submit it from command line, e.g. using the command [cURL] (http://man.cx/curl).

> Hint : If you use curl you can 
> - transfer lengthy data as json dictionary by using the option ```-d``` option, as shown for teh *Combined Search* at the end and
> - display the response in a nicer formated JSON dictionary by piping the command in ```| python -m json.tool```.
> How this is done is shown in the las section *Combinded Search*

If the query did not encounter an error, a submission returns as response a JSON dictionary with three keys:

- "help": the documentation string for the function you called.
- "success": true or false.
- "result": the returned result from the function you called, i.e. a list of (dictioanries describing) the records fulfilling the search criteria.

We illustrate this with the following 'search use cases', i.e. specific searches in the B2FIND catalogue for the facets offered in the B2FIND schema (see *03.a-map-metadata.md* ).

### 2. Some simple requests
We start with some simple list requests.

<!-- Hi,Christine : I guess we can remove this, it's fixed : teh correct syntax is ...?fq=coolfacet:Biology
> Note by Christine : Errors are returned as standard *HTTP errors*, e.g. the infamous **404** if the site is not available 
> or are returned as json strings as below where you search for a *coolfacet* in B2FIND:

```sh
http://b2find.eudat.eu/api/3/action/package_search?fq=&coolfacet=Biology
```
-->

#### List communities (groups)

To list all *groups* integrated in B2FIND submit the command
```sh
http://<CKAN_URL>/api/3/action/groups_list
```
To list e.g. all *communities* (realised as CKAN groups) integrated in B2FIND the according request responds a json dictionary, with the CKAN groups listed in the field *"results"*.
```sh
$ curl http://b2find.eudat.eu/api/3/action/group_list | python -m json.tool
    "help": "Return a list of the names of the site's groups.\n\n    :param order_by: the field to sort the list by, must be ``'name'`` or\n      ``'packages'`` (optional, default: ``'name'``) Deprecated use sort.\n    :type order_by: string\n    :param sort: sorting of the search results.  Optional.  Default:\n        \"name asc\" string of field name and sort-order. The allowed fields are\n        'name' and 'packages'\n    :type sort: string\n    :param groups: a list of names of the groups to return, if given only\n        groups whose names are in this list will be returned (optional)\n    :type groups: list of strings\n    :param all_fields: return full group dictionaries instead of  just names\n        (optional, default: ``False``)\n    :type all_fields: boolean\n\n    :rtype: list of strings\n\n    ",
    "result": [
        "aleph",
        "b2share",
        "cessda",
        "clarin",
        "dariah",
        "datacite",
        "earlinet",
        "enes",
        "gbif",
        "ist",
        "ivoa",
        "narcis",
        "pandata",
        "pdc",
        "sdl",
        "theeuropeanlibrary"
    ],
    "success": true
}
```

#### Excercise : List all CKAN groups available in other instances

#### Excercise : List tags (keywords)
List all `tags` available in ```b2find.eudat.eu``` and other CKAN instances.

#### Excercise : List datasets (packages)
List all `packages` (or datasets) available in ```b2find.eudat.eu``` and other CKAN instances.

### 3. Facetted search along a concrete Use Case
We explain the several facets you can search for in detail along a concrete use case. 

> A scientist is interested in research data on polar coasts.
> She knows that the 'Polar Data Catalogue' offers access
> to this kind of data. Furthermore, she knows that her colleague Dustin published
> some interesting datasets about this topic in the past 26 years.
> In the first step she restricts the search result on research concerning coasts
> to the 20th century. In the second step she filters for studies on a particular
> coastal region at the northern boarder between Alaska and Canada.   

In the following subsection we explain first how to search on single facets and finally we provide the result of a full combined search, which leads hopefully to the desired results our researcher needs for her own study.


#### Free text search

If you want to search for datasets whose metadata body contains *coast*, submit 
```sh
http://<CKAN_URL>/api/3/action/package_search?q=coast
```

Setting  <CKAN_URL> to ```b2find.eudat.eu``` results in more than 550 found datasets. The lengthy output is not shown here.

Try the same for other CKAN sites.

#### **Textual** facets

##### `Community` (or `Group`)
In B2FIND the facet *Communities* corresponds to the CKAN facet *groups*. 
The request to filter all datasets belonging to the community `PDC` in the B2FIND catalogue is

```sh
http://b2find.eudat.eu/api/3/action/package_search?fq=groups:pdc
```

##### Excersice: Search in ```demo.ckan.org``` for all datesets belonging to the group with *id* `governo`.
##### Exercise: Try to retrieve the *display_name* of the group with *id* `governo`. (Hint : use the function *group_show* )  

##### Discipline
**NOTE**, the following searches are dependent on the existence of the facet *Discipline*. While it is defined in the B2FIND schema it might not exist in your CKAN instance. Please use the *b2find.eudat.eu* instead.

To filter e.g. for all B2FIND datasets assigned to the discipline `Environmental Science` enter 
```sh
http://b2find.eudat.eu/api/3/action/package_search?fq=Discipline:Environmental?Science
```

> Note : We use here the wildcard *?* to assign any character between the words > 'Envirenmental' and 'Science'. So, as well 'Environmental?Science' will be found.
> !T.b.d. : Find out how to mask whitespaces in values of http requests 

##### Creator (or Author)
In B2FIND the facet *Creator* is mapped to the CKAN field *Author*. To filter e.g. for all datasets created by `Dustin Whalen` in the B2FIND repository enter 

```sh
http://b2find.eudat.eu/api/3/action/package_search?fq=author:Dustin?Whalen
```

Analogously, we search for datasets in demo.ckan.org whose author is *Lagares* :

```sh
http://demo.ckan.org//api/3/action/package_search?fq=author:Lagares
```

#### Coverage 
Sometimes you would like to filter for entries lying in a specific region or mentioning or being created in a specific periode of time. This information, however, is not part or not making sense for all all metadata records.

To enable these facets describing coverage *CKAN extensions* needs to be installed. This is done for the B2FIND service, the CKAN demo site offers only the geospatial search.

##### Publication year
The feature to filter for publication year is developed by and implemented in B2FIND by the CKAN extension [ckanext-datesearch] (https://github.com/EUDAT-B2FIND/ckanext-datesearch).

To search e.g. for all datasets which are published between the years 1990 and 2016 we have to use here the intrinsic extra fields `ext_startdate` and `ext_enddate` as shown here.

```sh
curl http://b2find.eudat.eu/api/3/action/package_search -d '
    {  "fq":"PublicationYear:*",
       "extras": { 
          "ext_startdate" : "1990-01-01T00:00:00Z",
          "ext_enddate" : "2016-12-31T23:59:59Z"
    }  
}' | python -m json.tool
```sh

> Note : The 'pre-filtering' of all datasets for which a publication year is assigned is needed to yield in a succesfully returned JSON object

##### Temporal Coverage (*Filter by Time*)
The feature to filter for temporal coverage is implemented in B2FIND through the CKAN extension [ckanext-timeline] (https://github.com/EUDAT-B2FIND/ckanext-timeline).

If you want to search for all datasets, which have an overlap with the 20th century, use the facets *ext_timeline_end* and *ext_timeline_end* for the start and end time of this periode, accordingly. Note that the values given here are in seconds since the calendar year 1:

> Note : This is not implemented yet.

##### Geospatial Coverage
The feature to filter for geospatial coverage is implemented in B2FIND through the adapted CKAN extension [ckanext-spatial] (https://github.com/ckan/ckanext-spatial).

Imagine we want to filter all datasets with a spatial extent that overlaps with a small region around the coast line at the northern border between Alaska and Canada.

Here we need the latitude and longitude coordinates of this region and have to use the CKAN extra field `ext_bbox` as follows :

```sh
http://b2find.eudat.eu/api/3/action/package_search -d '
    { "extras": 
	{ "ext_bbox" : "-141.0,69.5,-140.0,70.0" } 
    }'
```

### Combined search
We now want to combine all the single search criteria to satisfy the previous use case from our researcher. We will conducting several search requests sequentially.

I.e. for the example searches given above we search for all datasets that fulfill each of the following criteria (we only list here the facets which working properly by directly sending HTTP CKAN API requests):

1. The word `coast` is found in the full text body of the metadata record
2. The data belongs to the community *PDC*
3. The data is 'created' by `Dustin Whalen`
4. The data is originated from the discipline 'Environmental Science'
7. The spatial extent has an intersection with a small section of the northern costal line at the border between Alaska and Canada. 

You can combine several searches for facets. If you want e.g. run all the searches in the examples above in one run, you can enter the request in which you arrange all single facet searches into a line :

```sh
curl http://b2find.eudat.eu/api/3/action/package_search -d '
    { "q":"coast",
       "fq":"groups:pdc",
       "fq":"Discipline:Environmental?Science", 
       "fq":"author:Dustin?Whalen",
       "extras": { 
       	   "ext_bbox" : "-141.0,69.5,-140.0,70.0",
	   "ext_startdate" : "1990-01-01T00:00:00Z",
	   "ext_enddate" : "2016-12-31T23:59:59Z"
    }  
}' | python -m json.tool
```
