# Search using the Application Programming Interface (API)
This document describes how you can interact with a CKAN site by submitting directly HTTP requests using the CKAN API v3, on which as well the B2FIND API - and so the search via the GUI (see ```05.b-search-GUI.md```) and via the CLI (see ```05.c-search-CLI.md```) - is based on. For details see the [API guide of CKAN] (http://docs.ckan.org/en/latest/api/index.html). 

##Prerequisites

### 1. Internet browser
Supported and tested are

1. Firefox, version later than 45.x.y
2. Google Chrome, version later than 51.x.y

### 2. CKAN instance 

You can use your own CKAN installation (see module ```04-install-CKAN.md```) or the [CKAN Demo site] (http://demo.ckan.org/).
Or you access the [B2FIND portal] (http://b2find.eudat.eu) (we are open !). 

Please reset in the following the variable <CKAN_URL> with the URL of the used CKAN site.

## Usage

### 1. Submiting API Requests

You can enter the http requests directly in the address field of your internet browser or submit it from command line, e.g. using the command [cURL] (http://man.cx/curl) .

A HTTP request using directly *CKANâ€™s Action API*, version 3, has the following form 
```sh
http://<CKAN_URL>/api/3/action/<function>[?q=<value>[&fq<facet>:<value>]]
```
whereby the partly optional parameters assign :
 
- <CKAN_URL> is the URL of the CKAN site used,
- <function> is one of the API functions as `group_list` etc. ,
- <facet> is a field of the used schema (in case of B2FIND the B2FIND schema, see ...) and
- <value> is the corresponding value searched for 

A submission returns (if it not run in an `http error`) as response a JSON dictionary with three keys:

- "help": the documentation string for the function you called.
- "success": true or false.
- "result": the returned result from the function you called, i.e. a list of (dictioanries describing) the records fulfilling the search criteria.

We illustrate this with the following 'search use cases', i.e. specific searches in the B2FIND catalogue for the facets offered in the B2FIND schema (see *03.a-map-metadata.md* ).

### 2. Some simple requests
We start with some simple list requests.

#### List Communities (groups)

To see e.g. the *Communities* (implemented in CKAN as *Groups* ) submit
```sh
http://b2find.eudat.eu/api/3/action/group_list
```
results in
```sh
{
   "help": "Return a list of the names of the site's groups.\n\n    :param order_by: the field to sort the list by, must be ``'name'`` or\n      ``'packages'`` (optional, default: ``'name'``) Deprecated use sort.\n    :type order_by: string\n    :param sort: sorting of the search results.  Optional.  Default:\n        \"name asc\" string of field name and sort-order. The allowed fields are\n        'name' and 'packages'\n    :type sort: string\n    :param groups: a list of names of the groups to return, if given only\n        groups whose names are in this list will be returned (optional)\n    :type groups: list of strings\n    :param all_fields: return full group dictionaries instead of  just names\n        (optional, default: ``False``)\n    :type all_fields: boolean\n\n    :rtype: list of strings\n\n    ", 
   "success": true, 
  "result": ["aleph", "b2share", "cessda", "clarin", "dariah", "datacite", "earlinet", "enes", "gbif", "ist", "ivoa", "narcis", "pandata", "pdc", "sdl", "theeuropeanlibrary"]}
```

Try the same for other CKAN sites.

#### List Keywords (Tags)


#### List Datasets (Packages)

### 3. Facetted search along a concrete Use Case
We explain the several facets you can search for in detail along a concrete use case. 

> A scientist is interested in research data that is affected to polar coasts.
> She knows that the especially the 'Polar Data Catalogue' comprieses offers access
> to this kind of data. Furthermore she knows that her colleague Dustin published 
> some interesting datasets about this topic in the last 26 years.  
> In the first stage and to shrink the amount of found datasets she focus on research
> covering the 20th century. And she knows that there are interesting studies about a
> small coastal region at the northern boarder between Alaska and Canada.    

In the sub following sub section we explain first how for the single facets can be searched for
and finally we provide the result of a full combined search, which leads hopefully to the desired 
results our researcher needs for her own study. 


#### Free text search

If you want search for datasets in their metadata body occurs *coast*, submit 
```sh
http://<CKAN_URL>/api/3/action/package_search?q=coast
```

Setting  <CKAN_URL> to ```b2find.eudat.eu``` results in more than 550 found datasets. The lengthy output is not shown here.

#### **Textual** facets

##### `Community` (or `Group`)
 In B2FIND correspond communities to CKAN groups. 

To filter out e.g. all datasets in the B2FIND catalogue belonging to the community `PDC` enter 

```sh
http://b2find.eudat.eu/api/3/action/package_search?q=&groups=pdc
```

##### Discipline
Discipline is a facet of the B2FIND schema and not a default field by CKAN. So it makes only sense to search in the B2FIND catalogue - except you have as well defined a facet `Discipline` in the schema of your own CKAN instance. To filter out e.g. all B2FIND datasets assigned to the discipline `Environmental Science` enter 

```sh
http://b2find.eudat.eu/api/3/action/package_search?fq=Discipline:Environmental?Science
```

> Note : We use here the wildcard *?* to assign any character between the words > 'Envirenmental' and 'Science'. So, as well 'Environmental?Science' will be found.
> !T.b.d. : Find out how to mask whitespaces in values of http requests 

##### Creator (or Author)
In B2FIND correspond the facet *Creator* to the CKAN field *Author*. To filter out e.g. all datasets created by `Dustin Whalen` from B2FIND repository enter 

```sh
http://b2find.eudat.eu/api/3/action/package_search?fq=author:Dustin?Whalen
```

Analogously we search for datasets in demo.ckan.org which has an author with name *Lagres* :

```sh
http://demo.ckan.org//api/3/action/package_search?fq=author:Lagares
```

#### Coverage 
This means to filter out data objects which cover a specific region or periode. This information is only for a part of the metadata records available or senseful.

For these facets describing coverage the additional implementation of *CKAN extensions* are needed, as done for the B2FIND service and at least the geospatial search as well for the CKAN demo site.

##### Publication year
This is developed by and implemented in B2FIND by the CKAN extension [ckanext-datesearch] (https://github.com/EUDAT-B2FIND/ckanext-datesearch).

To search e.g. for all datasets which are published between the years 1990 and 2016 we have to use here the intrinsic extra fields `ext_startdate` and `ext_enddate` as shown here.



```sh
http://b2find.eudat.eu/api/3/action/package_search -d '{ "extras": { "ext_startdate" : "1990-01-01T00:00:00Z","ext_enddate" : "2016-12-31T23:59:59Z"  } }'
```

> Note : This returns actually a n ```internal server error```.
> Has to be fixed !!!

##### Temporal Coverage (*Filter by Time*)
This is developed by and implemented in B2FIND through the CKAN extension [ckanext-timeline] (https://github.com/EUDAT-B2FIND/ckanext-timeline).

To search e.g. for all datasets their temporal extent has an overlap with the 20th century, we use the extra fields `ext_timeline_start` and `ext_timeline_end` which expect seconds from year 0.

```sh
http://b2find.eudat.eu/api/3/action/package_search -d '{ "extras": { "ext_timeline_start" : "59941849015" , "ext_timeline_end" : "63129644811" } }'
``` 

> Note : This returns actually ```internal server error```.
> Has to be fixed !!!


##### Geospatial Coverage
This is implemented in B2FIND through the adapted CKAN extension [ckanext-spatial] (https://github.com/ckan/ckanext-spatial).

Imagine we want to filter out all datasets their spatial extent has an overlap with a small region around the coast line at the northern border between Alaska and Canada.

Here we need the latitude and longitude coordinates of this region and have to use the CKAN extra field `ext_bbox` as follows :

```sh
http://b2find.eudat.eu/api/3/action/package_search -d '{ "extras": { "ext_bbox" : "-141.0,69.5,-140.0,70.0" } }'
```

> Note : This has to be done. Not that easy to build the appropriate request here via a HTTP request 
### Combined search
We want now combine all the single search criteria together by conducting several search requests sequentially.

I.e. for the example searches given above we search for all datasets that fulfill each of the following criteria (we only list here the facets which working properly by directly sending HTTP CKAN API requests):

1. The word `coast` is found in the full text body of the metadata record
2. The data belongs to the community *PDC*
3. The data is 'created' by `Dustin Whalen`
4. The data is originated from the discipline 'Environmental Science'
7. The spatial extent has an intersection with a small section of the northern costal line at the border between Alaska and Canada. 


You can call all these sub requests in one call by joining them all together by `&` :

```sh
curl http://b2find.eudat.eu/api/3/action/package_search -d '
    { "q":"coast",
       "fq":"groups:pdc",
       "fq":"Discipline:Environmental?Science", 
       "fq":"author:Dustin?Whalen",
       "extras": { 
       	   "ext_bbox" : "-141.0,69.5,-140.0,70.0" }  
    }'
```
